<ion-header>
  <ion-toolbar>
    <ion-title>Inventario</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="load()">Actualizar</ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar>
    <ion-searchbar
      [(ngModel)]="q"
      placeholder="Buscar producto..."
      (ionInput)="load()"
      debounce="250">
    </ion-searchbar>
  </ion-toolbar>

  <ion-toolbar>
    <ion-item lines="none">
      <ion-label>Solo activos</ion-label>
      <ion-toggle [(ngModel)]="onlyActivos" (ionChange)="load()"></ion-toggle>
    </ion-item>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <ion-refresher slot="fixed" (ionRefresh)="load($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-spinner *ngIf="loading" class="ion-margin"></ion-spinner>

  <ion-card *ngFor="let p of products">
    <ion-card-header>
      <ion-card-title>{{ p.nombre }}</ion-card-title>
      <ion-card-subtitle>
        Stock: <b>{{ stockLabel(p) }}</b>
        <span *ngIf="!p.activo"> • (inactivo)</span>
      </ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col size="4">
            <ion-button expand="block" color="success" (click)="openMovement(p,'produccion')">
              Producción
            </ion-button>
          </ion-col>

          <ion-col size="4">
            <ion-button expand="block" color="warning" (click)="openMovement(p,'merma')">
              Merma
            </ion-button>
          </ion-col>

          <ion-col size="4">
            <ion-button expand="block" color="medium" (click)="openMovement(p,'ajuste')">
              Ajuste
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- ===== MODAL ===== -->
  <ion-modal [isOpen]="modalOpen" (didDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>
            {{ tipo === 'produccion' ? 'Producción' : (tipo === 'merma' ? 'Merma' : 'Ajuste') }}
          </ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">

        <ion-card *ngIf="selectedProduct">
          <ion-card-header>
            <ion-card-title>{{ selectedProduct.nombre }}</ion-card-title>
            <ion-card-subtitle>Stock actual: <b>{{ stockLabel(selectedProduct) }}</b></ion-card-subtitle>
          </ion-card-header>
        </ion-card>

        <ion-item>
          <ion-label position="stacked">
            Cantidad
            <span *ngIf="tipo==='merma'"> (se resta del stock)</span>
            <span *ngIf="tipo==='produccion'"> (se suma al stock)</span>
            <span *ngIf="tipo==='ajuste'"> (usa + o -)</span>
          </ion-label>

          <ion-input
            type="number"
            inputmode="decimal"
            [(ngModel)]="cantidad"
            placeholder="Ej: 10">
          </ion-input>
        </ion-item>

        <ion-item *ngIf="tipo==='ajuste'">
          <ion-note slot="start">
            Para ajuste, puedes usar negativo: -2 (resta) / 5 (suma)
          </ion-note>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Nota (opcional)</ion-label>
          <ion-textarea [(ngModel)]="nota" placeholder="Ej: se dañaron 2 en cocina..."></ion-textarea>
        </ion-item>

        <ion-button expand="block" class="ion-margin-top" (click)="saveMovement()">
          Guardar movimiento
        </ion-button>

      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>
